#!/bin/bash
# Power monitoring script - tracks battery drain and per-component power
# Usage: sudo power-monitor [interval_seconds] [duration_minutes]

INTERVAL=${1:-30}
DURATION_MIN=${2:-60}
TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
LOGFILE="/tmp/power-monitor-${TIMESTAMP}.log"
ITERATIONS=$((DURATION_MIN * 60 / INTERVAL))

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check for root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}Run with sudo for full RAPL data:${NC} sudo power-monitor"
    exit 1
fi

# RAPL paths
RAPL_PKG="/sys/class/powercap/intel-rapl/intel-rapl:0/energy_uj"
RAPL_CORE="/sys/class/powercap/intel-rapl/intel-rapl:0/intel-rapl:0:0/energy_uj"
RAPL_UNCORE="/sys/class/powercap/intel-rapl/intel-rapl:0/intel-rapl:0:1/energy_uj"
RAPL_PSYS="/sys/class/powercap/intel-rapl/intel-rapl:1/energy_uj"  # Platform/system domain if available

get_battery_info() {
    local capacity=$(cat /sys/class/power_supply/BAT0/capacity 2>/dev/null)
    local status=$(cat /sys/class/power_supply/BAT0/status 2>/dev/null)
    local power_now=$(cat /sys/class/power_supply/BAT0/power_now 2>/dev/null)
    local voltage=$(cat /sys/class/power_supply/BAT0/voltage_now 2>/dev/null)
    local current=$(cat /sys/class/power_supply/BAT0/current_now 2>/dev/null)

    # power_now in microwatts, or calculate from voltage*current
    local watts="0"
    if [[ -n "$power_now" && "$power_now" -gt 0 ]]; then
        watts=$(echo "scale=2; $power_now / 1000000" | bc)
    elif [[ -n "$voltage" && -n "$current" ]]; then
        watts=$(echo "scale=2; ($voltage * $current) / 1000000000000" | bc)
    fi
    echo "$capacity|$status|$watts"
}

get_cpu_freq_avg() {
    local sum=0
    local count=0
    for freq in /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq; do
        if [[ -f "$freq" ]]; then
            val=$(cat "$freq")
            sum=$((sum + val))
            count=$((count + 1))
        fi
    done
    if [[ $count -gt 0 ]]; then
        echo $((sum / count / 1000))
    else
        echo "0"
    fi
}

get_wifi_interrupts() {
    grep rtw89 /proc/interrupts 2>/dev/null | awk '{print $2}'
}

get_top_cpu_processes() {
    ps aux --sort=-%cpu | awk 'NR>1 && NR<=6 {
        cmd=$11
        gsub(/.*\//, "", cmd)  # basename
        if (length(cmd) > 15) cmd = substr(cmd, 1, 15)
        printf "%s(%.0f%%) ", cmd, $3
    }'
}

get_gpu_freq() {
    cat /sys/class/drm/card0/gt_cur_freq_mhz 2>/dev/null || \
    cat /sys/class/drm/card1/gt_cur_freq_mhz 2>/dev/null || \
    echo "n/a"
}

get_platform_profile() {
    cat /sys/firmware/acpi/platform_profile 2>/dev/null || echo "n/a"
}

get_browser_breakdown() {
    # Get per-process CPU for browsers, grouped by browser
    # Uses hyprctl for Wayland window titles
    local browser_log="$1"

    echo "--- Browser Breakdown ($(date '+%H:%M:%S')) ---" >> "$browser_log"

    # Get window titles from Hyprland (Wayland)
    declare -A WINDOW_TITLES
    if command -v hyprctl &>/dev/null; then
        while IFS=' ' read -r pid title; do
            WINDOW_TITLES[$pid]="$title"
        done < <(hyprctl clients -j 2>/dev/null | jq -r '.[] | "\(.pid) \(.title)"' 2>/dev/null)
    fi

    # Firefox processes
    echo "FIREFOX:" >> "$browser_log"
    local ff_main_pid=$(pgrep -x firefox | head -1)
    if [[ -n "$ff_main_pid" ]]; then
        local ff_title="${WINDOW_TITLES[$ff_main_pid]:-}"
        [[ -n "$ff_title" ]] && echo "  Window: $ff_title" >> "$browser_log"
    fi
    ps aux | grep -E '[f]irefox' | sort -k3 -rn | head -10 | awk '{printf "  PID %s: %s%% CPU, %s%% MEM\n", $2, $3, $4}' >> "$browser_log"

    # Brave processes
    echo "BRAVE:" >> "$browser_log"
    local brave_main_pid=$(pgrep -f "brave.*--type=browser" | head -1)
    if [[ -n "$brave_main_pid" ]]; then
        local brave_title="${WINDOW_TITLES[$brave_main_pid]:-}"
        [[ -n "$brave_title" ]] && echo "  Window: $brave_title" >> "$browser_log"
    fi
    ps aux | grep -E '[b]rave' | sort -k3 -rn | head -10 | awk '{printf "  PID %s: %s%% CPU, %s%% MEM (%s)\n", $2, $3, $4, $11}' >> "$browser_log"

    # Vivaldi processes
    echo "VIVALDI:" >> "$browser_log"
    local vivaldi_main_pid=$(pgrep -f "vivaldi.*--type=browser" | head -1)
    if [[ -n "$vivaldi_main_pid" ]]; then
        local vivaldi_title="${WINDOW_TITLES[$vivaldi_main_pid]:-}"
        [[ -n "$vivaldi_title" ]] && echo "  Window: $vivaldi_title" >> "$browser_log"
    fi
    ps aux | grep -E '[v]ivaldi' | sort -k3 -rn | head -10 | awk '{printf "  PID %s: %s%% CPU, %s%% MEM (%s)\n", $2, $3, $4, $11}' >> "$browser_log"

    echo "" >> "$browser_log"

    # Summary for display
    local ff_cpu=$(ps aux | grep -E '[f]irefox' | awk '{sum+=$3} END {printf "%.0f", sum}')
    local brave_cpu=$(ps aux | grep -E '[b]rave' | awk '{sum+=$3} END {printf "%.0f", sum}')
    local vivaldi_cpu=$(ps aux | grep -E '[v]ivaldi' | awk '{sum+=$3} END {printf "%.0f", sum}')
    local ff_procs=$(ps aux | grep -E '[f]irefox' | wc -l)
    local brave_procs=$(ps aux | grep -E '[b]rave.*--type=renderer' | wc -l)
    local vivaldi_procs=$(ps aux | grep -E '[v]ivaldi.*--type=renderer' | wc -l)

    echo "FF:${ff_cpu}%/${ff_procs}p BR:${brave_cpu}%/${brave_procs}t VI:${vivaldi_cpu}%/${vivaldi_procs}t"
}

# Header
BROWSER_LOG="/tmp/power-monitor-browsers-${TIMESTAMP}.log"
echo -e "${GREEN}=== Power Monitor (Full RAPL) ===${NC}"
echo "Interval: ${INTERVAL}s | Duration: ${DURATION_MIN}min"
echo "Log: $LOGFILE"
echo "Browser log: $BROWSER_LOG"
echo "---"

# Check RAPL availability
HAVE_PKG=false; HAVE_CORE=false; HAVE_UNCORE=false; HAVE_PSYS=false
[[ -r "$RAPL_PKG" ]] && HAVE_PKG=true
[[ -r "$RAPL_CORE" ]] && HAVE_CORE=true
[[ -r "$RAPL_UNCORE" ]] && HAVE_UNCORE=true
[[ -r "$RAPL_PSYS" ]] && HAVE_PSYS=true

echo "RAPL domains: PKG=$HAVE_PKG CORE=$HAVE_CORE UNCORE=$HAVE_UNCORE PSYS=$HAVE_PSYS"
echo "---"

# CSV header
HEADER="TIME,BAT%,STATUS,BAT_W,PKG_W,CORE_W,UNCORE_W,PSYS_W,CPU_MHZ,GPU_MHZ,WIFI_IRQ/s,PROFILE,TOP_PROCS"
echo "$HEADER" | tee "$LOGFILE"

# Initialize previous values
PREV_BATTERY=""
PREV_TIME=""
PREV_WIFI_IRQ=$(get_wifi_interrupts)
PREV_PKG=$(cat "$RAPL_PKG" 2>/dev/null)
PREV_CORE=$(cat "$RAPL_CORE" 2>/dev/null)
PREV_UNCORE=$(cat "$RAPL_UNCORE" 2>/dev/null)
PREV_PSYS=$(cat "$RAPL_PSYS" 2>/dev/null)
PREV_SAMPLE_TIME=$(date +%s.%N)

sleep 1  # Initial baseline

for ((i=1; i<=ITERATIONS; i++)); do
    TIMESTAMP=$(date '+%H:%M:%S')
    SAMPLE_TIME=$(date +%s.%N)

    # Get battery info
    IFS='|' read -r BAT_PCT BAT_STATUS BAT_WATTS <<< "$(get_battery_info)"

    # Get RAPL readings
    CUR_PKG=$(cat "$RAPL_PKG" 2>/dev/null)
    CUR_CORE=$(cat "$RAPL_CORE" 2>/dev/null)
    CUR_UNCORE=$(cat "$RAPL_UNCORE" 2>/dev/null)
    CUR_PSYS=$(cat "$RAPL_PSYS" 2>/dev/null)

    # Calculate power from energy delta (handles wraparound)
    TIME_DELTA=$(echo "$SAMPLE_TIME - $PREV_SAMPLE_TIME" | bc)

    calc_watts() {
        local cur=$1 prev=$2
        if [[ -n "$cur" && -n "$prev" && "$TIME_DELTA" != "0" ]]; then
            local delta=$((cur - prev))
            # Handle wraparound (energy counter resets at max)
            [[ $delta -lt 0 ]] && delta=$((delta + 16777216000000))
            echo "scale=2; $delta / 1000000 / $TIME_DELTA" | bc
        else
            echo "n/a"
        fi
    }

    PKG_W=$(calc_watts "$CUR_PKG" "$PREV_PKG")
    CORE_W=$(calc_watts "$CUR_CORE" "$PREV_CORE")
    UNCORE_W=$(calc_watts "$CUR_UNCORE" "$PREV_UNCORE")
    PSYS_W=$(calc_watts "$CUR_PSYS" "$PREV_PSYS")

    # Other metrics
    CPU_MHZ=$(get_cpu_freq_avg)
    GPU_MHZ=$(get_gpu_freq)
    TOP_PROCS=$(get_top_cpu_processes)
    PROFILE=$(get_platform_profile)
    BROWSER_SUMMARY=$(get_browser_breakdown "$BROWSER_LOG")

    # WiFi interrupt rate
    WIFI_IRQ=$(get_wifi_interrupts)
    WIFI_RATE="n/a"
    if [[ -n "$WIFI_IRQ" && -n "$PREV_WIFI_IRQ" ]]; then
        IRQ_DIFF=$((WIFI_IRQ - PREV_WIFI_IRQ))
        WIFI_RATE=$(echo "scale=0; $IRQ_DIFF / $TIME_DELTA" | bc)
    fi

    # Calculate battery drain rate
    DRAIN_INFO=""
    if [[ "$BAT_STATUS" == "Discharging" && -n "$PREV_BATTERY" ]]; then
        BAT_DIFF=$((PREV_BATTERY - BAT_PCT))
        if [[ $BAT_DIFF -gt 0 ]]; then
            DRAIN_RATE=$(echo "scale=1; $BAT_DIFF * 3600 / $TIME_DELTA" | bc 2>/dev/null)
            DRAIN_INFO=" (${DRAIN_RATE}%/hr)"
        fi
    fi

    # Color based on status
    if [[ "$BAT_STATUS" == "Discharging" ]]; then
        STATUS_COLOR="${YELLOW}"
    else
        STATUS_COLOR="${GREEN}"
    fi

    # Log to file
    LINE="$TIMESTAMP,$BAT_PCT,$BAT_STATUS,$BAT_WATTS,$PKG_W,$CORE_W,$UNCORE_W,$PSYS_W,$CPU_MHZ,$GPU_MHZ,$WIFI_RATE,$PROFILE,$TOP_PROCS"
    echo "$LINE" >> "$LOGFILE"

    # Display
    echo ""
    echo -e "${STATUS_COLOR}[$TIMESTAMP]${NC} ${CYAN}$PROFILE${NC} | Bat: ${BAT_PCT}%${DRAIN_INFO} | Total: ${BAT_WATTS}W"
    echo -e "  ${CYAN}RAPL:${NC} PKG=${PKG_W}W | Core=${CORE_W}W | Uncore=${UNCORE_W}W | PSys=${PSYS_W}W"
    echo -e "  ${CYAN}Freq:${NC} CPU=${CPU_MHZ}MHz GPU=${GPU_MHZ}MHz | WiFi: ${WIFI_RATE}/s"
    echo -e "  ${CYAN}Browsers:${NC} $BROWSER_SUMMARY"
    echo -e "  ${CYAN}Top:${NC} $TOP_PROCS"

    # Store for next iteration
    PREV_BATTERY=$BAT_PCT
    PREV_TIME=$(date +%s)
    PREV_WIFI_IRQ=$WIFI_IRQ
    PREV_PKG=$CUR_PKG
    PREV_CORE=$CUR_CORE
    PREV_UNCORE=$CUR_UNCORE
    PREV_PSYS=$CUR_PSYS
    PREV_SAMPLE_TIME=$SAMPLE_TIME

    [[ $i -lt $ITERATIONS ]] && sleep $INTERVAL
done

echo ""
echo -e "${GREEN}=== Done ===${NC}"
echo "Log saved to: $LOGFILE"
echo "Browser details: $BROWSER_LOG"

# Summary - properly accounts for AC vs battery time
echo ""
echo "=== Summary ==="
awk -F',' '
BEGIN {
    bat_samples=0; ac_samples=0;
    bat_drain=0; bat_start=-1; bat_end=-1;
    bat_pkg=0; ac_pkg=0;
}
NR>1 {
    pct = $2
    status = $3
    pkg = $5

    if (status == "Discharging") {
        bat_samples++
        if (bat_start < 0) bat_start = pct
        bat_end = pct
        if (pkg != "n/a") bat_pkg += pkg
    } else {
        ac_samples++
        if (pkg != "n/a") ac_pkg += pkg
    }
}
END {
    total = bat_samples + ac_samples
    interval = '$INTERVAL'

    bat_min = bat_samples * interval / 60
    ac_min = ac_samples * interval / 60

    printf "Time breakdown:\n"
    printf "  On battery: %.0f min (%.0f%%)\n", bat_min, (bat_samples/total)*100
    printf "  On AC:      %.0f min (%.0f%%)\n", ac_min, (ac_samples/total)*100

    if (bat_samples > 0 && bat_start >= 0 && bat_end >= 0) {
        drain = bat_start - bat_end
        if (drain > 0 && bat_min > 0) {
            rate = drain * 60 / bat_min
            printf "\nBattery drain (battery-only):\n"
            printf "  %d%% -> %d%% = %d%% in %.0f min\n", bat_start, bat_end, drain, bat_min
            printf "  Drain rate: %.1f%%/hr\n", rate
            printf "  Est. full drain: %.1f hrs (from 100%%)\n", 100/rate
        }
    }

    printf "\nAvg package power:\n"
    if (bat_samples > 0) printf "  On battery: %.1fW\n", bat_pkg/bat_samples
    if (ac_samples > 0) printf "  On AC:      %.1fW\n", ac_pkg/ac_samples
}' "$LOGFILE"

# Average power by component
echo ""
echo "Component breakdown (all samples):"
awk -F',' 'NR>1 {
    if ($5 != "n/a") { pkg+=$5; pkg_n++ }
    if ($6 != "n/a") { core+=$6; core_n++ }
    if ($7 != "n/a") { unc+=$7; unc_n++ }
}
END {
    if (pkg_n>0) printf "  Package: %.1fW\n", pkg/pkg_n
    if (core_n>0) printf "  Cores:   %.1fW\n", core/core_n
    if (unc_n>0) printf "  Uncore:  %.1fW\n", unc/unc_n
}' "$LOGFILE"
